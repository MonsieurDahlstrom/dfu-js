{"version":3,"sources":["../../src/actions/update-actions.js"],"names":["MutationTypes","DFU_BASE","DFUSecure","replace","DFU_CHAR_BASE","DFUSecureControlPoint","DFUSecurePacket","DFUCharacteristicsForDevice","device","gatt","getPrimaryService","service","getCharacteristic","packetPoint","controlPoint","identifier","id","UpdateActions","webBluetoothDFUCreateUpdate","bluetoothDevice","dispatch","commit","metadata","update","ADD_UPDATE","webBluetoothDFURemoveUpdate","REMOVE_UPDATE","webBluetoothDFUCancelUpdate","state","FAILED","MODIFED_UPDATE","webBluetoothDFURestoreUpdate","payload","setControlPoint","setPacketPoint","setDeviceIdentifier","webBluetoothDFUSendFirmware","firmware","IDLE","sections","section","transfers","push","dat","controlpointCharacteristic","packetCharacteristic","Command","length","bin","Data"],"mappings":"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","file":"update-actions.js","sourcesContent":["import {Update, UpdateStates} from '../models/update'\nimport {Firmware} from '../models/firmware'\nimport Transfer from '../models/transfer'\nimport {TransferObjectType} from '../models/transfer-object'\nimport * as MutationTypes from '../mutation-types'\n\n// DFU by Nordic Semiconductor\nconst DFU_BASE = '0000xxxx-0000-1000-8000-00805f9b34fb'\nexport const DFUSecure = DFU_BASE.replace('xxxx', 'fe59')\nconst DFU_CHAR_BASE = '8ec9xxxx-f315-4f60-9fb8-838830daea50'\n// Control Point is notify, write\nexport const DFUSecureControlPoint = DFU_CHAR_BASE.replace('xxxx', '0001')\n// Packet is Write No Response\nexport const DFUSecurePacket = DFU_CHAR_BASE.replace('xxxx', '0002')\n\nconst DFUCharacteristicsForDevice = async function (device) {\n  let service = await device.gatt.getPrimaryService(DFUSecure)\n  let packetPoint = await service.getCharacteristic(DFUSecurePacket)\n  let controlPoint = await service.getCharacteristic(DFUSecureControlPoint)\n  return {identifier: device.id, packetPoint: packetPoint, controlPoint: controlPoint}\n}\n\nconst UpdateActions = {\n\n  async webBluetoothDFUCreateUpdate({ dispatch, commit }, bluetoothDevice) {\n    let metadata = await DFUCharacteristicsForDevice(bluetoothDevice)\n    let update = new Update(metadata.identifier, metadata.controlPoint, metadata.packetPoint)\n    commit(MutationTypes.ADD_UPDATE, update)\n  },\n\n  async webBluetoothDFURemoveUpdate({ dispatch, commit }, update) {\n    commit(MutationTypes.REMOVE_UPDATE, update)\n  },\n\n  async webBluetoothDFUCancelUpdate({ dispatch, commit }, update) {\n    update.state = UpdateStates.FAILED\n    commit(MutationTypes.MODIFED_UPDATE, update)\n  },\n\n  async webBluetoothDFURestoreUpdate({ dispatch, commit }, payload) {\n    let metadata = await DFUCharacteristicsForDevice(payload.bluetoothDevice)\n    payload.update.setControlPoint(metadata.controlPoint)\n    payload.update.setPacketPoint(metadata.packetPoint)\n    payload.update.setDeviceIdentifier(payload.bluetoothDevice.id)\n    commit(MutationTypes.MODIFED_UPDATE, payload.update)\n  },\n\n  /**\n    Send a firmware to a device. Throws when parameter or state is invalid for sending a firmware\n  **/\n  async webBluetoothDFUSendFirmware({ dispatch, commit }, payload) {\n    let firmware = payload.firmware\n    let update = payload.update\n    if (firmware instanceof Firmware && update instanceof Update) {\n      if (update.state === UpdateStates.IDLE) {\n        for(var section of firmware.sections) {\n          update.transfers.push(new Transfer(section.dat, update.controlpointCharacteristic, update.packetCharacteristic, TransferObjectType.Command))\n          update.transfers[update.transfers.length-1].update = update\n          dispatch('webBluetoothDFUTransferAdd', update.transfers[update.transfers.length-1])\n          update.transfers.push(new Transfer(section.bin, update.controlpointCharacteristic, update.packetCharacteristic, TransferObjectType.Data))\n          update.transfers[update.transfers.length-1].update = update\n          dispatch('webBluetoothDFUTransferAdd', update.transfers[update.transfers.length-1])\n        }\n        dispatch('webBluetoothDFUTransferBegin', update.transfers[0])\n        commit(MutationTypes.MODIFED_UPDATE, update)\n      }\n    }\n  }\n}\n\nexport default UpdateActions\n"]}