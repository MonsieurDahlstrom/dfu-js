{"version":3,"sources":["../../src/actions/transfer-actions.js"],"names":["MutationTypes","GenerateObjects","dispatch","transfer","fileBegin","fileEnd","file","length","index","objectBegin","objectEnd","maxObjectLength","object","objectType","objects","push","TransferActions","webBluetoothDFUTransferAdd","commit","controlPointEventHandler","event","dataView","target","value","controlPoint","addEventListener","ADD_TRANSFER","webBluetoothDFUTransferRemove","removeEventListener","REMOVE_TRANSFER","webBluetoothDFUTransferBegin","write","Verify","UPDATE_TRANSFER","webBluetoothDFUTransferPrepare","payload","maxiumSize","currentOffset","offset","currentCRC","checksum","currentObjectIndex","find","item","hasOffset","indexOf","state","Transfering","validatePayload","transferObject","webBluetoothDFUTransferNextObject","Completed","webBluetoothDFUTransferEventHandler","getInt8","Actions","RESPONSE_CODE","Prepare","opCode","responseCode","SELECT","Responses","SUCCESS","getUint32"],"mappings":"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","file":"transfer-actions.js","sourcesContent":["import Write from '../models/write'\r\nimport * as MutationTypes from '../mutation-types'\r\nimport TransmissionStatus from '../models/transmission-types'\r\nimport {TransferObject} from '../models/transfer-object'\r\n\r\nconst GenerateObjects = function (dispatch, transfer) {\r\n  let fileBegin = 0\r\n  let fileEnd = transfer.file.length\r\n  let index = fileBegin\r\n  while (index < fileEnd) {\r\n    let objectBegin = index\r\n    let objectEnd = objectBegin + transfer.maxObjectLength < fileEnd ? transfer.maxObjectLength : (fileEnd - index)\r\n    let object = new TransferObject(objectBegin, objectEnd, transfer, transfer.objectType)\r\n    object.transfer = transfer\r\n    transfer.objects.push(object)\r\n    dispatch('webBluetoothDFUObjectAdd', object)\r\n    index += transfer.maxObjectLength\r\n  }\r\n}\r\n\r\nconst TransferActions = {\r\n\r\n  async webBluetoothDFUTransferAdd({ dispatch, commit }, transfer) {\r\n    transfer.controlPointEventHandler = function(event) {\r\n      dispatch('webBluetoothDFUTransferEventHandler', {transfer: transfer, dataView: event.target.value})\r\n    }\r\n    transfer.controlPoint.addEventListener('characteristicvaluechanged', transfer.controlPointEventHandler)\r\n    commit(MutationTypes.ADD_TRANSFER, transfer)\r\n  },\r\n\r\n  /** Clean up event registrations when transfer is completed **/\r\n  async webBluetoothDFUTransferRemove({ dispatch, commit }, transfer) {\r\n    transfer.controlPoint.removeEventListener('characteristicvaluechanged', transfer.controlPointEventHandler)\r\n    commit(MutationTypes.REMOVE_TRANSFER, transfer)\r\n  },\r\n\r\n  /** Begin the tranfer of a file by asking the NRF51/52 for meta data and verify if the file has been transfered already **/\r\n  async webBluetoothDFUTransferBegin({ dispatch, commit }, transfer) {\r\n    let write = new Write.Verify(this.controlPoint, this.objectType)\r\n    dispatch('webBluetoothDFUScheduleWrite', write)\r\n    dispatch('webBluetoothDFUExecuteWrite', write)\r\n    commit(MutationTypes.UPDATE_TRANSFER, transfer)\r\n  },\r\n\r\n  /**\r\n  Given the type of device and object type, the maxium size that can be processed\r\n  at a time varies. This method creates a set of TransferObject with this maxium size\r\n  set.\r\n\r\n  Secondly the device reports back how much of the file has been transfered and what the crc\r\n  so far is. This method skips object that has already been completed\r\n  **/\r\n  async webBluetoothDFUTransferPrepare({ dispatch, commit }, payload) {\r\n    let transfer = payload.transfer\r\n    let maxiumSize = payload.maxiumSize\r\n    let currentOffset = payload.offset\r\n    let currentCRC = payload.checksum\r\n    //\r\n    transfer.maxObjectLength = maxiumSize\r\n    transfer.objects = []\r\n    transfer.currentObjectIndex = 0\r\n    GenerateObjects(dispatch, transfer)\r\n    /** Skip to object for the offset **/\r\n    let object = transfer.objects.find((item) => item.hasOffset(currentOffset))\r\n    if (object) {\r\n      transfer.currentObjectIndex = transfer.objects.indexOf(object)\r\n    }\r\n    transfer.state = TransmissionStatus.Transfering\r\n    let validatePayload = {checksum: currentCRC, offset: currentOffset, transferObject: transfer.objects[transfer.currentObjectIndex]}\r\n    dispatch('webBluetoothDFUObjectValidate', validatePayload)\r\n    commit(MutationTypes.UPDATE_TRANSFER, transfer)\r\n  },\r\n\r\n  /** Checks if Transfer is complete or starts transferring the next TransferObject **/\r\n  async webBluetoothDFUTransferNextObject({ dispatch, commit }, transfer) {\r\n    if (transfer.currentObjectIndex < transfer.objects.length - 1) {\r\n      transfer.currentObjectIndex++\r\n      dispatch('webBluetoothDFUObjectBegin', transfer.objects[transfer.currentObjectIndex])\r\n    } else {\r\n      transfer.state = TransmissionStatus.Completed\r\n    }\r\n    commit(MutationTypes.UPDATE_TRANSFER, transfer)\r\n  },\r\n\r\n  /** handles events received on the Control Point Characteristic **/\r\n  async webBluetoothDFUTransferEventHandler({ dispatch, commit }, payload) {\r\n    let dataView = payload.dataView\r\n    let transfer = payload.transfer\r\n    /** guard to filter events that are not response codes  */\r\n    if(dataView.getInt8(0) !== Write.Actions.RESPONSE_CODE) {\r\n      return\r\n    }\r\n    switch (transfer.state) {\r\n      case TransmissionStatus.Prepare: {\r\n        let opCode = dataView.getInt8(1)\r\n        let responseCode = dataView.getInt8(2)\r\n        if (opCode === Write.Actions.SELECT && responseCode === Write.Responses.SUCCESS) {\r\n          dispatch('webBluetoothDFUTransferPrepare', {checksum: dataView.getUint32(11, true), offset:  dataView.getUint32(7, true), maxiumSize: dataView.getUint32(3, true), transfer: transfer})\r\n        }\r\n        break\r\n      }\r\n      default: {\r\n        /** Check that objects have been prepared for this transfer*/\r\n        if (transfer.currentObjectIndex >= 0) {\r\n          var transferObject = transfer.objects[transfer.currentObjectIndex]\r\n          if(transferObject) {\r\n            dispatch('webBluetoothDFUObjectHandleEvent', {dataView: dataView, transferObject: transferObject})\r\n          }\r\n        }\r\n        break\r\n      }\r\n    }\r\n  }\r\n\r\n}\r\n\r\nexport default TransferActions\r\n"]}