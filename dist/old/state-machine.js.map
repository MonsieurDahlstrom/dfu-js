{"version":3,"sources":["../../src/old/state-machine.js"],"names":["StateMachineStates","NOT_CONFIGURED","IDLE","TRANSFERING","COMPLETE","FAILED","StateMachine","webBluetoothControlPoint","webBluetoothPacketPoint","_state","Object","defineProperty","get","set","value","delegate","undefined","updateStateMachine","configurable","setControlPoint","setPacketPoint","fileTransfers","controlpointCharacteristic","packetCharacteristic","state","webBluetoothCharacteristic","progress","console","error","transfer","push","kill","firmware","Error","sections","section","addTransfer","dat","Command","bin","Data","module","exports","States"],"mappings":"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","file":"state-machine.js","sourcesContent":["// Copyright (c) 2017 Monsieur DahlstrÃ¶m Ltd\r\n//\r\n// Permission is hereby granted, free of charge, to any person obtaining a\r\n// copy of this software and associated documentation files (the\r\n// \"Software\"), to deal in the Software without restriction, including\r\n// without limitation the rights to use, copy, modify, merge, publish,\r\n// distribute, sublicense, and/or sell copies of the Software, and to permit\r\n// persons to whom the Software is furnished to do so, subject to the\r\n// following conditions:\r\n//\r\n// The above copyright notice and this permission notice shall be included\r\n// in all copies or substantial portions of the Software.\r\n//\r\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS\r\n// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\r\n// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN\r\n// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,\r\n// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR\r\n// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE\r\n// USE OR OTHER DEALINGS IN THE SOFTWARE.\r\nimport queue from 'async/queue'\r\nimport {Firmware} from './firmware'\r\nimport {Transfer, TransferWorker, CurrentTransfer, TransferObjectType} from './dfu'\r\n\r\n/**\r\nThe states a DFU StateMachine can have:\r\n  - NOT_CONFIGURED, bluetooth characteristics have not been set\r\n  - IDLE, state machine is ready for use\r\n  - TRANSFERING, state machine is i the process of updating a device\r\n  - COMPLETE, indicates that a device update has been completed\r\n  - FAILED, device update failed\r\n**/\r\nconst StateMachineStates = {\r\n  NOT_CONFIGURED: 0x00,\r\n  IDLE: 0x01,\r\n  TRANSFERING: 0x02,\r\n  COMPLETE: 0x03,\r\n  FAILED: 0x04\r\n}\r\n\r\n/**\r\nMain Facade class to the library\r\n  Create StateMachine with WebBluetoothCharacteristics representing the data and control point\r\n  Monitor the state property and use the function sendFirmware() to send a DFU zip.\r\n**/\r\nclass StateMachine {\r\n\r\n  constructor (webBluetoothControlPoint, webBluetoothPacketPoint) {\r\n    this._state = StateMachineStates.NOT_CONFIGURED\r\n    Object.defineProperty(this,\"state\",{\r\n      get: function () {\r\n        return this._state\r\n      },\r\n      set: function (value) {\r\n        this._state = value\r\n        if (this.delegate !== undefined) {\r\n          this.delegate.updateStateMachine()\r\n        }\r\n      },\r\n      configurable: true\r\n    })\r\n    this.setControlPoint(webBluetoothControlPoint)\r\n    this.setPacketPoint(webBluetoothPacketPoint)\r\n    /** TODO: The queue should have better error reporting which are tied to state */\r\n    this.fileTransfers = queue(TransferWorker, 1)\r\n    if (this.controlpointCharacteristic && this.packetCharacteristic) {\r\n      this.state = StateMachineStates.IDLE\r\n    }\r\n  }\r\n/*\r\n  constructor (webBluetoothControlPoint, webBluetoothPacketPoint) {\r\n    this.state = StateMachineStates.NOT_CONFIGURED\r\n    this.setControlPoint(webBluetoothControlPoint)\r\n    this.setPacketPoint(webBluetoothPacketPoint)\r\n    this.fileTransfers = queue(TransferWorker, 1)\r\n    if (this.controlpointCharacteristic && this.packetCharacteristic) {\r\n      this.state = StateMachineStates.IDLE\r\n    }\r\n  }\r\n*/\r\n  setDelegate (delegate) {\r\n    this.delegate = delegate\r\n  }\r\n\r\n  setControlPoint (webBluetoothCharacteristic) {\r\n    this.controlpointCharacteristic = webBluetoothCharacteristic\r\n    if (this.state === StateMachineStates.NOT_CONFIGURED && this.controlpointCharacteristic !== undefined && this.packetCharacteristic !== undefined) {\r\n      this.state = StateMachineStates.IDLE\r\n    }\r\n  }\r\n\r\n  setPacketPoint (webBluetoothCharacteristic) {\r\n    this.packetCharacteristic = webBluetoothCharacteristic\r\n    if (this.state === StateMachineStates.NOT_CONFIGURED && this.controlpointCharacteristic !== undefined && this.packetCharacteristic !== undefined) {\r\n      this.state = StateMachineStates.IDLE\r\n    }\r\n  }\r\n\r\n  progress () {\r\n    switch (this.state) {\r\n      case StateMachineStates.NOT_CONFIGURED:\r\n        return 0.0\r\n      case StateMachineStates.IDLE:\r\n        return 0.0\r\n      case StateMachineStates.COMPLETE:\r\n        return 1.0\r\n      case StateMachineStates.FAILED:\r\n        return 1.0\r\n      case StateMachineStates.TRANSFERING:\r\n        if (CurrentTransfer !== undefined) {\r\n          return CurrentTransfer.progress()\r\n        } else {\r\n          console.error('DFU StateMachine is in State Transfering but no transfer is set')\r\n          return 0.0\r\n        }\r\n    }\r\n  }\r\n  /**\r\n    Internal method used to slot each part of a dfu zip for transfer to device\r\n  **/\r\n  addTransfer (transfer) {\r\n    this.fileTransfers.push(transfer, (error) => {\r\n      if (error) {\r\n        this.fileTransfers.kill()\r\n      }\r\n    })\r\n  }\r\n\r\n  /**\r\n    Send a firmware to a device. Throws when parameter or state is invalid for sending a firmware\r\n  **/\r\n  sendFirmware (firmware) {\r\n    if (this.state === StateMachineStates.NOT_CONFIGURED) {\r\n      throw new Error('StateMachine is not configured with bluetooth characteristics')\r\n    }\r\n    if (this.state !== StateMachineStates.IDLE) {\r\n      throw new Error('Can only initate transfer when idle')\r\n    }\r\n    if (firmware instanceof Firmware === false) {\r\n      throw new Error('Firmware needs to be of class Firmware')\r\n    }\r\n    for(var section of firmware.sections) {\r\n      this.addTransfer(new Transfer(section.dat, this.controlpointCharacteristic, this.packetCharacteristic, TransferObjectType.Command))\r\n      this.addTransfer(new Transfer(section.bin, this.controlpointCharacteristic, this.packetCharacteristic, TransferObjectType.Data))\r\n    }\r\n  }\r\n\r\n}\r\n\r\nmodule.exports.States = StateMachineStates\r\nmodule.exports.StateMachine = StateMachine\r\n"]}