{"version":3,"sources":["../../src/dfu/Transfer.js"],"names":["TransferState","Prepare","Transfer","Completed","Failed","TransferObjectType","Command","Data","TransferWorker","currentTransfer","undefined","task","onCompleition","Error","begin","intervalTimer","setInterval","state","clearInterval","end","fileData","controlPoint","packetPoint","objectType","file","bleTasks","Worker","error","console","difference","currentObjectIndex","objects","length","progress","dfuTask","push","kill","addEventListener","onEvent","bind","operation","verify","addTask","removeEventListener","maxiumSize","currentOffset","currentCRC","maxObjectLength","generateObjects","object","find","item","hasOffset","indexOf","validate","fileBegin","fileEnd","index","objectBegin","objectEnd","nextObject","event","dataView","target","value","getInt8","RESPONSE_CODE","log","opCode","responseCode","SELECT","SUCCESS","getUint32","prepareTransferObjects","eventHandler","module","exports"],"mappings":";;;;;;;;;;AAsBA;;;;AAEA;;AACA;;;;AAEA,IAAMA,gBAAgB;AACpBC,WAAS,IADW;AAEpBC,YAAU,IAFU;AAGpBC,aAAW,IAHS;AAIpBC,UAAQ;AAJY,CAAtB;;AAYA,IAAMC,qBAAqB;AACzBC,WAAS,IADgB;AAEzBC,QAAM;AAFmB,CAA3B;;IAaMC,c;AAEJ,4BAAe;AAAA;;AACb,SAAKC,eAAL,GAAuBC,SAAvB;AACD;;;;yBAGKC,I,EAAMC,a,EAAe;AAAA;;AACzB,UAAID,gBAAgBT,QAAhB,KAA6B,KAAjC,EAAwC;AACtC,cAAM,IAAIW,KAAJ,CAAU,0BAAV,CAAN;AACD;AACD,UAAI,CAACD,aAAL,EAAoB;AAClB,cAAM,IAAIC,KAAJ,CAAU,0BAAV,CAAN;AACD;AACD,WAAKJ,eAAL,GAAuBE,IAAvB;AACAA,WAAKG,KAAL;AACA,UAAMC,gBAAgBC,YAAY,YAAM;AACtC,YAAIL,KAAKM,KAAL,KAAejB,cAAcI,MAAjC,EAAyC;AACvCc,wBAAcH,aAAd;AACAJ,eAAKQ,GAAL;AACAP,wBAAc,iBAAd;AACD,SAJD,MAIO,IAAID,KAAKM,KAAL,KAAejB,cAAcG,SAAjC,EAA4C;AACjDe,wBAAcH,aAAd;AACAJ,eAAKQ,GAAL;AACA,gBAAKV,eAAL,GAAuBC,SAAvB;AACAE;AACD;AACF,OAXqB,EAWnB,IAXmB,CAAtB;AAYD;;;;;IAGGV,Q;AAEJ,oBAAakB,QAAb,EAAuBC,YAAvB,EAAqCC,WAArC,EAAkDC,UAAlD,EAA8D;AAAA;;AAC5D,SAAKN,KAAL,GAAajB,cAAcC,OAA3B;;AAEA,SAAKqB,WAAL,GAAmBA,WAAnB;AACA,SAAKD,YAAL,GAAoBA,YAApB;;AAEA,SAAKG,IAAL,GAAYJ,QAAZ;;AAEA,SAAKG,UAAL,GAAkBA,UAAlB;;AAEA,SAAKE,QAAL,GAAgB,qBAAM,WAAKC,MAAX,EAAmB,CAAnB,CAAhB;AACA,SAAKD,QAAL,CAAcE,KAAd,GAAsB,UAACA,KAAD,EAAQhB,IAAR,EAAiB;AACrCiB,cAAQD,KAAR,CAAcA,KAAd;AACAC,cAAQD,KAAR,CAAchB,IAAd;AACD,KAHD;AAID;;;;+BAEW;AACV,cAAQ,KAAKM,KAAb;AACE,aAAKjB,cAAcC,OAAnB;AACA;AACE,mBAAO,GAAP;AACD;AACD,aAAKD,cAAcE,QAAnB;AACA;AACE,gBAAI2B,aAAa,CAAC,KAAKC,kBAAL,GAAwB,CAAzB,IAA8B,KAAKC,OAAL,CAAaC,MAA5D;AACA,gBAAIH,aAAa,GAAjB,EAAsB;AACpB,qBAAOA,aAAa,KAAKE,OAAL,CAAa,KAAKD,kBAAlB,EAAsCG,QAAtC,EAApB;AACD,aAFD,MAEO;AACL,qBAAOJ,aAAa,IAApB;AACD;AACF;AACD;AACA;AACE,mBAAO,GAAP;AACD;AAjBH;AAmBD;;;4BAGQK,O,EAAS;AAAA;;AAChB,UAAIA,kCAA4B,KAAhC,EAAuC;AACrC,cAAM,IAAIrB,KAAJ,CAAU,0BAAV,CAAN;AACD;AACD,WAAKY,QAAL,CAAcU,IAAd,CAAmBD,OAAnB,EAA4B,UAACP,KAAD,EAAW;AACrC,YAAIA,KAAJ,EAAW;AACT,iBAAKF,QAAL,CAAcW,IAAd;AACA,iBAAKnB,KAAL,GAAajB,cAAcI,MAA3B;AACAwB,kBAAQD,KAAR,CAAcA,KAAd;AACD;AACF,OAND;AAOD;;;4BAGQ;AACP,WAAKN,YAAL,CAAkBgB,gBAAlB,CAAmC,4BAAnC,EAAiE,KAAKC,OAAL,CAAaC,IAAb,CAAkB,IAAlB,CAAjE;AACA,UAAIC,YAAY,WAAKC,MAAL,CAAY,KAAKlB,UAAjB,EAA6B,KAAKF,YAAlC,CAAhB;AACA,WAAKqB,OAAL,CAAaF,SAAb;AACD;;;0BAGM;AACL,WAAKnB,YAAL,CAAkBsB,mBAAlB,CAAsC,4BAAtC,EAAoE,KAAKL,OAAzE;AACD;;;2CAUuBM,U,EAAYC,a,EAAeC,U,EAAY;AAC7D,WAAKC,eAAL,GAAuBH,UAAvB;AACA,WAAKb,OAAL,GAAe,EAAf;AACA,WAAKD,kBAAL,GAA0B,CAA1B;AACA,WAAKkB,eAAL;;AAEA,UAAIC,SAAS,KAAKlB,OAAL,CAAamB,IAAb,CAAkB,UAACC,IAAD;AAAA,eAAUA,KAAKC,SAAL,CAAeP,aAAf,CAAV;AAAA,OAAlB,CAAb;AACA,UAAII,MAAJ,EAAY;AACV,aAAKnB,kBAAL,GAA0B,KAAKC,OAAL,CAAasB,OAAb,CAAqBJ,MAArB,CAA1B;AACD;AACD,WAAKhC,KAAL,GAAajB,cAAcE,QAA3B;AACA,WAAK6B,OAAL,CAAa,KAAKD,kBAAlB,EAAsCwB,QAAtC,CAA+CT,aAA/C,EAA8DC,UAA9D;AACD;;;sCAKkB;AACjB,UAAIS,YAAY,CAAhB;AACA,UAAIC,UAAU,KAAKhC,IAAL,CAAUQ,MAAxB;AACA,UAAIyB,QAAQF,SAAZ;AACA,aAAOE,QAAQD,OAAf,EAAwB;AACtB,YAAIE,cAAcD,KAAlB;AACA,YAAIE,YAAYD,cAAc,KAAKX,eAAnB,GAAqCS,OAArC,GAA+C,KAAKT,eAApD,GAAuES,UAAUC,KAAjG;AACA,YAAIR,SAAS,mCAAmBS,WAAnB,EAAgCC,SAAhC,EAA2C,IAA3C,EAAiD,KAAKpC,UAAtD,EAAkE,KAAKqC,UAAL,CAAgBrB,IAAhB,CAAqB,IAArB,CAAlE,CAAb;AACA,aAAKR,OAAL,CAAaI,IAAb,CAAkBc,MAAlB;AACAQ,iBAAS,KAAKV,eAAd;AACD;AACF;;;4BAGQc,K,EAAO;AAEd,UAAIC,WAAWD,MAAME,MAAN,CAAaC,KAA5B;AACA,UAAIF,YAAYA,SAASG,OAAT,CAAiB,CAAjB,MAAwB,eAASC,aAAjD,EAAgE;AAC9DtC,gBAAQuC,GAAR,CAAY,mDAAZ;AACA;AACD;AACD,cAAQ,KAAKlD,KAAb;AACE,aAAKjB,cAAcC,OAAnB;AAA4B;AAC1B,gBAAImE,SAASN,SAASG,OAAT,CAAiB,CAAjB,CAAb;AACA,gBAAII,eAAeP,SAASG,OAAT,CAAiB,CAAjB,CAAnB;AACA,gBAAIG,WAAW,eAASE,MAApB,IAA8BD,iBAAiB,iBAAWE,OAA9D,EAAuE;AACrE,kBAAI3B,aAAakB,SAASU,SAAT,CAAmB,CAAnB,EAAsB,IAAtB,CAAjB;AACA,kBAAI3B,gBAAgBiB,SAASU,SAAT,CAAmB,CAAnB,EAAsB,IAAtB,CAApB;AACA,kBAAI1B,aAAagB,SAASU,SAAT,CAAmB,EAAnB,EAAuB,IAAvB,CAAjB;AACA,mBAAKC,sBAAL,CAA4B7B,UAA5B,EAAwCC,aAAxC,EAAuDC,UAAvD;AACD;AACD;AACD;AACD;AAAS;AACP,iBAAKf,OAAL,CAAa,KAAKD,kBAAlB,EAAsC4C,YAAtC,CAAmDZ,QAAnD;AACA;AACD;AAfH;AAiBD;;;iCAGa;AACZ,UAAI,KAAKhC,kBAAL,GAA0B,KAAKC,OAAL,CAAaC,MAAb,GAAsB,CAApD,EAAuD;AACrD,aAAKP,QAAL,CAAcW,IAAd;AACA,aAAKN,kBAAL;AACA,aAAKC,OAAL,CAAa,KAAKD,kBAAlB,EAAsChB,KAAtC;AACD,OAJD,MAIO;AACL,aAAKG,KAAL,GAAajB,cAAcG,SAA3B;AACD;AACF;;;;;AAGHwE,OAAOC,OAAP,CAAe1E,QAAf,GAA0BA,QAA1B;AACAyE,OAAOC,OAAP,CAAepE,cAAf,GAAgCA,cAAhC;;AAEAmE,OAAOC,OAAP,CAAe5E,aAAf,GAA+BA,aAA/B;AACA2E,OAAOC,OAAP,CAAevE,kBAAf,GAAoCA,kBAApC","file":"Transfer.js","sourcesContent":["// Copyright (c) 2017 Monsieur DahlstrÃ¶m Ltd\n//\n// Permission is hereby granted, free of charge, to any person obtaining a\n// copy of this software and associated documentation files (the\n// \"Software\"), to deal in the Software without restriction, including\n// without limitation the rights to use, copy, modify, merge, publish,\n// distribute, sublicense, and/or sell copies of the Software, and to permit\n// persons to whom the Software is furnished to do so, subject to the\n// following conditions:\n//\n// The above copyright notice and this permission notice shall be included\n// in all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS\n// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\n// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN\n// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,\n// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR\n// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE\n// USE OR OTHER DEALINGS IN THE SOFTWARE.\n\n/** Library imports */\nimport queue from 'async/queue'\n/** internal imports */\nimport {TransferObject} from './TransferObject'\nimport {Task, TaskType, TaskResult} from './Task'\n\nconst TransferState = {\n  Prepare: 0x00,\n  Transfer: 0x01,\n  Completed: 0x02,\n  Failed: 0x03\n}\n\n/**\nNordic defines two different type of file transfers:\n    init package is known as Command object\n    firmware is known as Data object\n**/\nconst TransferObjectType = {\n  Command: 0x01,\n  Data: 0x02\n}\n\n/**\nTransfer class represents a binary file inside a firmware update zip.\nA firmware update consists of a init package and data file. The StateMachine\nparases the zip file and creates a transfer object for each entry in the zip\n\nThe statemachine uses a queue to slot the Transfers in order\n**/\n\nclass TransferWorker {\n\n  constructor () {\n    this.currentTransfer = undefined\n  }\n\n  /** The queue inside StateMachine uses this function to process each Transfer **/\n  work (task, onCompleition) {\n    if (task instanceof Transfer === false) {\n      throw new Error('task is not of type Task')\n    }\n    if (!onCompleition) {\n      throw new Error('onCompleition is not set')\n    }\n    this.currentTransfer = task\n    task.begin()\n    const intervalTimer = setInterval(() => {\n      if (task.state === TransferState.Failed) {\n        clearInterval(intervalTimer)\n        task.end()\n        onCompleition('Failed Transfer')\n      } else if (task.state === TransferState.Completed) {\n        clearInterval(intervalTimer)\n        task.end()\n        this.currentTransfer = undefined\n        onCompleition()\n      }\n    }, 1000)\n  }\n}\n\nclass Transfer {\n\n  constructor (fileData, controlPoint, packetPoint, objectType) {\n    this.state = TransferState.Prepare\n    /** The WebBluetooth Characteristics needed to transfer a file **/\n    this.packetPoint = packetPoint\n    this.controlPoint = controlPoint\n    /** Data array representing the actual file to transfer **/\n    this.file = fileData\n    /** The TransferObjectType this file represents */\n    this.objectType = objectType\n    /** Create a queue to process the TransferObject's for this file in order */\n    this.bleTasks = queue(Task.Worker, 1)\n    this.bleTasks.error = (error, task) => {\n      console.error(error)\n      console.error(task)\n    }\n  }\n\n  progress () {\n    switch (this.state) {\n      case TransferState.Prepare:\n      {\n        return 0.0\n      }\n      case TransferState.Transfer:\n      {\n        var difference = (this.currentObjectIndex+1) / this.objects.length\n        if (difference < 1.0) {\n          return difference - this.objects[this.currentObjectIndex].progress()\n        } else {\n          return difference - 0.02\n        }\n      }\n      default:\n      {\n        return 1.0\n      }\n    }\n  }\n\n  /** Schedules a BLE Action for execution and ensure the file transfer fail if an action cant be completed **/\n  addTask (dfuTask) {\n    if (dfuTask instanceof Task === false) {\n      throw new Error('task is not of type Task')\n    }\n    this.bleTasks.push(dfuTask, (error) => {\n      if (error) {\n        this.bleTasks.kill()\n        this.state = TransferState.Failed\n        console.error(error)\n      }\n    })\n  }\n\n  /** Begin the tranfer of a file by asking the NRF51/52 for meta data and verify if the file has been transfered already **/\n  begin () {\n    this.controlPoint.addEventListener('characteristicvaluechanged', this.onEvent.bind(this))\n    let operation = Task.verify(this.objectType, this.controlPoint)\n    this.addTask(operation)\n  }\n\n  /** Clean up event registrations when transfer is completed **/\n  end () {\n    this.controlPoint.removeEventListener('characteristicvaluechanged', this.onEvent)\n  }\n\n  /**\n  Given the type of device and object type, the maxium size that can be processed\n  at a time varies. This method creates a set of TransferObject with this maxium size\n  set.\n\n  Secondly the device reports back how much of the file has been transfered and what the crc\n  so far is. This method skips object that has already been completed\n  **/\n  prepareTransferObjects (maxiumSize, currentOffset, currentCRC) {\n    this.maxObjectLength = maxiumSize\n    this.objects = []\n    this.currentObjectIndex = 0\n    this.generateObjects()\n    /** Skip to object for the offset **/\n    let object = this.objects.find((item) => item.hasOffset(currentOffset))\n    if (object) {\n      this.currentObjectIndex = this.objects.indexOf(object)\n    }\n    this.state = TransferState.Transfer\n    this.objects[this.currentObjectIndex].validate(currentOffset, currentCRC)\n  }\n\n  /**\n  Internal convinence method.\n  **/\n  generateObjects () {\n    let fileBegin = 0\n    let fileEnd = this.file.length\n    let index = fileBegin\n    while (index < fileEnd) {\n      let objectBegin = index\n      let objectEnd = objectBegin + this.maxObjectLength < fileEnd ? this.maxObjectLength : (fileEnd - index)\n      let object = new TransferObject(objectBegin, objectEnd, this, this.objectType, this.nextObject.bind(this))\n      this.objects.push(object)\n      index += this.maxObjectLength\n    }\n  }\n\n  /** handles events received on the Control Point Characteristic **/\n  onEvent (event) {\n    /** guard to filter events that are not response codes  */\n    let dataView = event.target.value\n    if (dataView && dataView.getInt8(0) !== TaskType.RESPONSE_CODE) {\n      console.log('Transfer.onEvent() opcode was not a response code')\n      return\n    }\n    switch (this.state) {\n      case TransferState.Prepare: {\n        let opCode = dataView.getInt8(1)\n        let responseCode = dataView.getInt8(2)\n        if (opCode === TaskType.SELECT && responseCode === TaskResult.SUCCESS) {\n          let maxiumSize = dataView.getUint32(3, true)\n          let currentOffset = dataView.getUint32(7, true)\n          let currentCRC = dataView.getUint32(11, true)\n          this.prepareTransferObjects(maxiumSize, currentOffset, currentCRC)\n        }\n        break\n      }\n      default: {\n        this.objects[this.currentObjectIndex].eventHandler(dataView)\n        break\n      }\n    }\n  }\n\n  /** Checks if Transfer is complete or starts transferring the next TransferObject **/\n  nextObject () {\n    if (this.currentObjectIndex < this.objects.length - 1) {\n      this.bleTasks.kill()\n      this.currentObjectIndex++\n      this.objects[this.currentObjectIndex].begin()\n    } else {\n      this.state = TransferState.Completed\n    }\n  }\n}\n\nmodule.exports.Transfer = Transfer\nmodule.exports.TransferWorker = TransferWorker\n\nmodule.exports.TransferState = TransferState\nmodule.exports.TransferObjectType = TransferObjectType\n"]}