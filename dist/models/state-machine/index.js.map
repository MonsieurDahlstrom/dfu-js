{"version":3,"sources":["../../../src/models/state-machine/index.js"],"names":["stateSymbol","controlPointSymbol","packetPointSymbol","transfersSymbol","queueSymbol","progressSymbol","StateMachine","webBluetoothControlPoint","webBluetoothPacketPoint","undefined","IDLE","NOT_CONFIGURED","state","progress","COMPLETE","FAILED","TRANSFERING","transfers","length","completedTransfersCount","reduce","sum","value","Failed","Completed","percentageValue","newProgress","Transfer","transfer","push","queue","error","kill","firmware","Error","sections","section","updateFunc","event","calculateProgress","datTransfer","dat","controlPoint","packetPoint","Command","on","binTransfer","bin","Data","addTransfer","emit","dfuStateMachine","webBluetoothCharacteristic","module","exports","DFUStateMachineStates","DFUStateMachine"],"mappings":"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","file":"index.js","sourcesContent":["// Copyright (c) 2017 Monsieur DahlstrÃ¶m Ltd\r\n//\r\n// Permission is hereby granted, free of charge, to any person obtaining a\r\n// copy of this software and associated documentation files (the\r\n// \"Software\"), to deal in the Software without restriction, including\r\n// without limitation the rights to use, copy, modify, merge, publish,\r\n// distribute, sublicense, and/or sell copies of the Software, and to permit\r\n// persons to whom the Software is furnished to do so, subject to the\r\n// following conditions:\r\n//\r\n// The above copyright notice and this permission notice shall be included\r\n// in all copies or substantial portions of the Software.\r\n//\r\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS\r\n// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\r\n// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN\r\n// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,\r\n// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR\r\n// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE\r\n// USE OR OTHER DEALINGS IN THE SOFTWARE.\r\n\r\nimport queue from 'async/queue'\r\nimport EventEmitter from 'events'\r\n\r\nimport {Firmware, FirmwareType} from '../firmware'\r\nimport {Transfer, TransferStates, TransferWorker, CurrentTransfer, TransferTypes} from '../transfer'\r\nimport {Task} from '../task'\r\nimport StateMachineStates from './states'\r\n\r\n/**\r\nMain Facade class to the library\r\n  Create StateMachine with WebBluetoothCharacteristics representing the data and control point\r\n  Monitor the state property and use the function sendFirmware() to send a DFU zip.\r\n**/\r\n\r\nlet stateSymbol = Symbol()\r\nlet controlPointSymbol = Symbol()\r\nlet packetPointSymbol = Symbol()\r\nlet transfersSymbol = Symbol()\r\nlet queueSymbol = Symbol()\r\nlet progressSymbol = Symbol()\r\n\r\nclass StateMachine extends EventEmitter {\r\n\r\n  constructor (webBluetoothControlPoint, webBluetoothPacketPoint) {\r\n    super()\r\n    this[controlPointSymbol] = webBluetoothControlPoint\r\n    this[packetPointSymbol] = webBluetoothPacketPoint\r\n    if (this[controlPointSymbol] !== undefined && this[packetPointSymbol] !== undefined) {\r\n      this[stateSymbol] = StateMachineStates.IDLE\r\n    } else {\r\n      this[stateSymbol] = StateMachineStates.NOT_CONFIGURED\r\n    }\r\n    this[transfersSymbol] = []\r\n    this[queueSymbol] = queue(TransferWorker, 1)\r\n    this[progressSymbol] = 0.0\r\n  }\r\n\r\n  /** get/set **/\r\n  get state () {\r\n    return this[stateSymbol]\r\n  }\r\n\r\n  set state (value) {\r\n    if (value !== this[stateSymbol]) {\r\n      this[stateSymbol] = value\r\n      this.emit('stateChanged',{dfuStateMachine: this, state: value})\r\n    }\r\n  }\r\n  /** get/set **/\r\n\r\n  get controlPoint () {\r\n    return this[controlPointSymbol]\r\n  }\r\n\r\n  set controlPoint (webBluetoothCharacteristic) {\r\n    this[controlPointSymbol] = webBluetoothCharacteristic\r\n    if (this.state === StateMachineStates.NOT_CONFIGURED && (this[controlPointSymbol] !== undefined && this[packetPointSymbol] !== undefined)) {\r\n      this.state = StateMachineStates.IDLE\r\n    } else if(this.state === StateMachineStates.IDLE && (this[controlPointSymbol] === undefined ||  this[packetPointSymbol] === undefined)) {\r\n      this.state = StateMachineStates.NOT_CONFIGURED\r\n    }\r\n  }\r\n\r\n  /** get/set **/\r\n\r\n  get packetPoint () {\r\n    return this[packetPointSymbol]\r\n  }\r\n\r\n  set packetPoint (webBluetoothCharacteristic) {\r\n    this[packetPointSymbol] = webBluetoothCharacteristic\r\n    if (this.state === StateMachineStates.NOT_CONFIGURED && (this[controlPointSymbol] !== undefined && this[packetPointSymbol] !== undefined)) {\r\n      this.state = StateMachineStates.IDLE\r\n    } else if(this.state === StateMachineStates.IDLE && (this[controlPointSymbol] === undefined ||  this[packetPointSymbol] === undefined)) {\r\n      this.state = StateMachineStates.NOT_CONFIGURED\r\n    }\r\n  }\r\n\r\n  /** get/set **/\r\n\r\n  get transfers () {\r\n    return this[transfersSymbol]\r\n  }\r\n\r\n\r\n  /** get/set **/\r\n\r\n  get progress () {\r\n    return this[progressSymbol]\r\n  }\r\n\r\n  set progress (value) {\r\n    if (value !== this[progressSymbol]) {\r\n      this[progressSymbol] = value\r\n      this.emit('progressChanged',{dfuStateMachine: this, progress: value})\r\n    }\r\n  }\r\n  /** get/set **/\r\n\r\n  get queue () {\r\n    return this[queueSymbol]\r\n  }\r\n\r\n\r\n  calculateProgress () {\r\n    switch (this.state) {\r\n      case StateMachineStates.NOT_CONFIGURED:\r\n        this.progress = 0.0\r\n        break\r\n      case StateMachineStates.IDLE:\r\n        this.progress = 0.0\r\n        break\r\n      case StateMachineStates.COMPLETE:\r\n        this.progress = 1.0\r\n        break\r\n      case StateMachineStates.FAILED:\r\n        this.progress = 1.0\r\n        break\r\n      case StateMachineStates.TRANSFERING:\r\n        if (this.transfers.length > 0) {\r\n          let completedTransfersCount = this.transfers.reduce((sum,value) => {\r\n            return (value.state === TransferStates.Failed || value.state === TransferStates.Completed) ? sum + 1 : sum\r\n          }, 0)\r\n          let percentageValue = 1.0 / this.transfers.length\r\n          let newProgress = percentageValue * completedTransfersCount\r\n          if(CurrentTransfer().state === TransferStates.Transfer) {\r\n            newProgress += percentageValue * CurrentTransfer().progress\r\n          }\r\n          this.progress = newProgress\r\n        }\r\n        break\r\n    }\r\n  }\r\n  /**\r\n    Internal method used to slot each part of a dfu zip for transfer to device\r\n  **/\r\n  addTransfer (transfer) {\r\n    this.transfers.push(transfer)\r\n    this.queue.push(transfer, (error) => {\r\n      if (error) {\r\n        this.queue.kill()\r\n        this.state = StateMachineStates.FAILED\r\n      } else if(this.queue.length() === 0) {\r\n        this.state = StateMachineStates.COMPLETE\r\n      }\r\n    })\r\n  }\r\n\r\n  /**\r\n    Send a firmware to a device. Throws when parameter or state is invalid for sending a firmware\r\n  **/\r\n  sendFirmware (firmware) {\r\n    if (this.state === StateMachineStates.NOT_CONFIGURED) {\r\n      throw new Error('StateMachine is not configured with bluetooth characteristics')\r\n    }\r\n    if (this.state !== StateMachineStates.IDLE) {\r\n      throw new Error('Can only initate transfer when idle')\r\n    }\r\n    if (firmware instanceof Firmware === false) {\r\n      throw new Error('Firmware needs to be of class Firmware')\r\n    }\r\n    for(var section of firmware.sections) {\r\n      var updateFunc = (event) => {\r\n        this.calculateProgress()\r\n      }\r\n      let datTransfer = new Transfer(section.dat, this.controlPoint, this.packetPoint, TransferTypes.Command)\r\n      datTransfer.on('progressChanged', updateFunc)\r\n      let binTransfer = new Transfer(section.bin, this.controlPoint, this.packetPoint, TransferTypes.Data)\r\n      binTransfer.on('progressChanged', updateFunc)\r\n      this.addTransfer(datTransfer)\r\n      this.addTransfer(binTransfer)\r\n    }\r\n    this.state = StateMachineStates.TRANSFERING\r\n  }\r\n\r\n}\r\n\r\nmodule.exports.DFUStateMachineStates = StateMachineStates\r\nmodule.exports.DFUStateMachine = StateMachine\r\n"]}