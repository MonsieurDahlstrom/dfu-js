{"version":3,"sources":["../../../src/models/transfer/transfer.js"],"names":["fileSymbol","stateSymbol","packetPointSymbol","controlPointSymbol","tasksSymbol","objectsSymbol","maximumObjectLengthSymbol","typeSymbol","progressSymbol","Transfer","value","emit","transfer","progress","fileData","controlPoint","packetPoint","objectType","Prepare","Worker","error","task","console","objects","length","completedObjects","reduce","sum","state","Completed","Failed","dfuTask","Error","tasks","push","kill","addEventListener","onEvent","bind","operation","verify","type","addTask","removeEventListener","maxiumSize","currentOffset","currentCRC","maximumObjectLength","currentObjectIndex","generateObjects","object","find","item","hasOffset","indexOf","validate","fileBegin","fileEnd","file","index","objectBegin","objectEnd","nextObject","event","dataView","target","getInt8","RESPONSE_CODE","log","opCode","responseCode","SELECT","SUCCESS","getUint32","prepareDFUObjects","undefined","eventHandler","checkProgress","begin"],"mappings":"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","file":"transfer.js","sourcesContent":["\"use strict\";\r\n\r\n/** Library imports */\r\nimport queue from 'async/queue'\r\nimport EventEmitter from 'events'\r\n/** internal imports */\r\nimport TransferStates from './states'\r\nimport {Task, TaskTypes, TaskResults} from '../task'\r\nimport {DFUObject, DFUObjectStates} from '../dfu-object'\r\n\r\nvar fileSymbol = Symbol();\r\nvar stateSymbol = Symbol();\r\nvar packetPointSymbol = Symbol();\r\nvar controlPointSymbol = Symbol();\r\nvar tasksSymbol = Symbol();\r\nvar objectsSymbol = Symbol();\r\nvar maximumObjectLengthSymbol = Symbol()\r\nvar typeSymbol = Symbol()\r\nvar progressSymbol = Symbol()\r\n\r\nclass Transfer extends EventEmitter {\r\n  /** Get/Set pair **/\r\n  get file() {\r\n    return this[fileSymbol]\r\n  }\r\n\r\n  set file(value) {\r\n    this[fileSymbol] = value\r\n  }\r\n\r\n  /** Get/Set pair **/\r\n  get state() {\r\n    return this[stateSymbol]\r\n  }\r\n\r\n  set state(value) {\r\n    this[stateSymbol] = value\r\n  }\r\n\r\n  /** Get/Set pair **/\r\n  get packetPoint() {\r\n    return this[packetPointSymbol]\r\n  }\r\n\r\n  set packetPoint(value) {\r\n    this[packetPointSymbol] = value\r\n  }\r\n\r\n  /** Get/Set pair **/\r\n  get controlPoint() {\r\n    return this[controlPointSymbol]\r\n  }\r\n\r\n  set controlPoint(value) {\r\n    this[controlPointSymbol] = value\r\n  }\r\n\r\n  /** Get/Set pair **/\r\n  get tasks() {\r\n    return this[tasksSymbol]\r\n  }\r\n\r\n  set tasks(value) {\r\n    this[tasksSymbol] = value\r\n  }\r\n\r\n  /** Get/Set pair **/\r\n  get objects() {\r\n    return this[objectsSymbol]\r\n  }\r\n\r\n  set objects(value) {\r\n    this[objectsSymbol] = value\r\n  }\r\n\r\n  /** Get/Set pair **/\r\n  get maximumObjectLength() {\r\n    return this[maximumObjectLengthSymbol]\r\n  }\r\n\r\n  set maximumObjectLength(value) {\r\n    this[maximumObjectLengthSymbol] = value\r\n  }\r\n\r\n  /** Get/Set pair **/\r\n  get type() {\r\n    return this[typeSymbol]\r\n  }\r\n\r\n  set type(value) {\r\n    this[typeSymbol] = value\r\n  }\r\n\r\n  /** Get/Set pair **/\r\n  get progress() {\r\n    return this[progressSymbol]\r\n  }\r\n\r\n  set progress(value) {\r\n    if(value !== this[progressSymbol]) {\r\n      this[progressSymbol] = value\r\n      this.emit('progressChanged', {transfer: this, progress: value})\r\n    }\r\n  }\r\n\r\n  constructor (fileData, controlPoint, packetPoint, objectType) {\r\n    super()\r\n    this[stateSymbol] = TransferStates.Prepare\r\n    /** The WebBluetooth Characteristics needed to transfer a file **/\r\n    this[packetPointSymbol] = packetPoint\r\n    this[controlPointSymbol] = controlPoint\r\n    /** Data array representing the actual file to transfer **/\r\n    this[fileSymbol] = fileData\r\n    /** The DFUObjectType this file represents */\r\n    this[typeSymbol] = objectType\r\n    /** Create a queue to process the DFUObject's for this file in order */\r\n    this[tasksSymbol] = queue(Task.Worker, 1)\r\n    this[tasksSymbol].error = (error, task) => {\r\n      console.error(error)\r\n      console.error(task)\r\n    }\r\n    /** empty list of DFUObject */\r\n    this[objectsSymbol] = []\r\n    this[progressSymbol] = 0\r\n  }\r\n\r\n  checkProgress () {\r\n    if(this.objects.length > 0) {\r\n      let completedObjects = this.objects.reduce((sum,value) => {\r\n        if (value.state === DFUObjectStates.Completed || value.state === DFUObjectStates.Failed) {\r\n          return sum += 1\r\n        } else {\r\n          return sum\r\n        }\r\n      }, 0)\r\n      this.progress = completedObjects / this.objects.length\r\n    }\r\n  }\r\n  /** Schedules a BLE Action for execution and ensure the file transfer fail if an action cant be completed **/\r\n  addTask (dfuTask) {\r\n    if ((dfuTask instanceof Task) === false) {\r\n      throw new Error('task is not of type Task')\r\n    }\r\n    this.tasks.push(dfuTask, (error) => {\r\n      if (error) {\r\n        this.tasks.kill()\r\n        this.state = TransferStates.Failed\r\n        console.error(error)\r\n      }\r\n    })\r\n  }\r\n\r\n  /** Begin the tranfer of a file by asking the NRF51/52 for meta data and verify if the file has been transfered already **/\r\n  begin () {\r\n    this.controlPoint.addEventListener('characteristicvaluechanged', this.onEvent.bind(this))\r\n    let operation = Task.verify(this.type, this.controlPoint)\r\n    this.addTask(operation)\r\n  }\r\n\r\n  /** Clean up event registrations when transfer is completed **/\r\n  end () {\r\n    this.controlPoint.removeEventListener('characteristicvaluechanged', this.onEvent)\r\n  }\r\n\r\n  /**\r\n  Given the type of device and object type, the maxium size that can be processed\r\n  at a time varies. This method creates a set of DFUObject with this maxium size\r\n  set.\r\n\r\n  Secondly the device reports back how much of the file has been transfered and what the crc\r\n  so far is. This method skips object that has already been completed\r\n  **/\r\n  prepareDFUObjects (maxiumSize, currentOffset, currentCRC) {\r\n    this.maximumObjectLength = maxiumSize\r\n    this.currentObjectIndex = 0\r\n    this.generateObjects()\r\n    /** Skip to object for the offset **/\r\n    let object = this.objects.find((item) => item.hasOffset(currentOffset))\r\n    if (object) {\r\n      this.currentObjectIndex = this.objects.indexOf(object)\r\n    }\r\n    this.state = TransferStates.Transfer\r\n    this.objects[this.currentObjectIndex].validate(currentOffset, currentCRC)\r\n  }\r\n\r\n  /**\r\n  Internal convinence method.\r\n  **/\r\n  generateObjects () {\r\n    let fileBegin = 0\r\n    let fileEnd = this.file.length\r\n    let index = fileBegin\r\n    while (index < fileEnd) {\r\n      let objectBegin = index\r\n      let objectEnd = objectBegin + this.maximumObjectLength < fileEnd ? this.maximumObjectLength : (fileEnd - index)\r\n      let object = new DFUObject(objectBegin, objectEnd, this, this.type, this.nextObject.bind(this))\r\n      this.objects.push(object)\r\n      index += this.maximumObjectLength\r\n    }\r\n  }\r\n\r\n  /** handles events received on the Control Point Characteristic **/\r\n  onEvent (event) {\r\n    /** guard to filter events that are not response codes  */\r\n    let dataView = event.target.value\r\n    if (dataView && dataView.getInt8(0) !== TaskTypes.RESPONSE_CODE) {\r\n      console.log('Transfer.onEvent() opcode was not a response code')\r\n      return\r\n    }\r\n    switch (this.state) {\r\n      case TransferStates.Prepare: {\r\n        let opCode = dataView.getInt8(1)\r\n        let responseCode = dataView.getInt8(2)\r\n        if (opCode === TaskTypes.SELECT && responseCode === TaskResults.SUCCESS) {\r\n          let maxiumSize = dataView.getUint32(3, true)\r\n          let currentOffset = dataView.getUint32(7, true)\r\n          let currentCRC = dataView.getUint32(11, true)\r\n          this.prepareDFUObjects(maxiumSize, currentOffset, currentCRC)\r\n        }\r\n        break\r\n      }\r\n      default: {\r\n        if (this.objects !== undefined && this.objects[this.currentObjectIndex] !== undefined) {\r\n          this.objects[this.currentObjectIndex].eventHandler(dataView)\r\n        } else {\r\n          console.error('Transfer.onEvent called with no objects or no current object')\r\n        }\r\n        break\r\n      }\r\n    }\r\n    this.checkProgress()\r\n  }\r\n\r\n  /** Checks if Transfer is complete or starts transferring the next DFUObject **/\r\n  nextObject () {\r\n    if (this.currentObjectIndex < this.objects.length - 1) {\r\n      this.tasks.kill()\r\n      this.currentObjectIndex++\r\n      this.objects[this.currentObjectIndex].begin()\r\n    } else {\r\n      this.state = TransferStates.Completed\r\n    }\r\n  }\r\n}\r\n\r\nexport default Transfer\r\n"]}