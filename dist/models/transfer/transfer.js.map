{"version":3,"sources":["../../../src/models/transfer/transfer.js"],"names":["fileSymbol","stateSymbol","packetPointSymbol","controlPointSymbol","objectsSymbol","maximumObjectLengthSymbol","typeSymbol","progressSymbol","Transfer","value","emit","transfer","state","progress","fileData","controlPoint","packetPoint","objectType","Prepare","Completed","Failed","percentagePerObject","objects","length","reduce","sum","dfuObject","Storing","Transfering","percentageCompleted","completed","size","addEventListener","onEvent","bind","operation","verify","type","Worker","removeEventListener","maxiumSize","currentOffset","currentCRC","maximumObjectLength","currentObjectIndex","generateObjects","object","find","item","hasOffset","indexOf","validate","fileBegin","fileEnd","file","index","objectBegin","objectEnd","on","event","nextObject","checkProgress","push","dataView","target","getInt8","RESPONSE_CODE","console","warn","opCode","responseCode","SELECT","SUCCESS","getUint32","prepareDFUObjects","undefined","eventHandler","begin"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","file":"transfer.js","sourcesContent":["/** Library imports */\nimport EventEmitter from 'events'\n/** internal imports */\nimport TransferStates from './states'\nimport {Task, TaskTypes, TaskResults} from '../task'\nimport {DFUObject, DFUObjectStates} from '../dfu-object'\n\nvar fileSymbol = Symbol();\nvar stateSymbol = Symbol();\nvar packetPointSymbol = Symbol();\nvar controlPointSymbol = Symbol();\nvar objectsSymbol = Symbol();\nvar maximumObjectLengthSymbol = Symbol()\nvar typeSymbol = Symbol()\nvar progressSymbol = Symbol()\n\nclass Transfer extends EventEmitter {\n  /** Get/Set pair **/\n  get file() {\n    return this[fileSymbol]\n  }\n\n  set file(value) {\n    this[fileSymbol] = value\n  }\n\n  /** Get/Set pair **/\n  get state() {\n    return this[stateSymbol]\n  }\n\n  set state(value) {\n    if(this[stateSymbol] !== value) {\n      this[stateSymbol] = value\n      this.emit('stateChanged', {transfer:this, state:this[stateSymbol]})\n    }\n  }\n\n  /** Get/Set pair **/\n  get packetPoint() {\n    return this[packetPointSymbol]\n  }\n\n  set packetPoint(value) {\n    this[packetPointSymbol] = value\n  }\n\n  /** Get/Set pair **/\n  get controlPoint() {\n    return this[controlPointSymbol]\n  }\n\n  set controlPoint(value) {\n    this[controlPointSymbol] = value\n  }\n\n  /** Get/Set pair **/\n  get objects() {\n    return this[objectsSymbol]\n  }\n\n  set objects(value) {\n    this[objectsSymbol] = value\n  }\n\n  /** Get/Set pair **/\n  get maximumObjectLength() {\n    return this[maximumObjectLengthSymbol]\n  }\n\n  set maximumObjectLength(value) {\n    this[maximumObjectLengthSymbol] = value\n  }\n\n  /** Get/Set pair **/\n  get type() {\n    return this[typeSymbol]\n  }\n\n  set type(value) {\n    this[typeSymbol] = value\n  }\n\n  /** Get/Set pair **/\n  get progress() {\n    return this[progressSymbol]\n  }\n\n  set progress(value) {\n    if(value !== this[progressSymbol]) {\n      this[progressSymbol] = value\n      this.emit('progressChanged', {transfer: this, progress: value})\n    }\n  }\n\n  constructor (fileData, controlPoint, packetPoint, objectType) {\n    super()\n    this[stateSymbol] = TransferStates.Prepare\n    /** The WebBluetooth Characteristics needed to transfer a file **/\n    this[packetPointSymbol] = packetPoint\n    this[controlPointSymbol] = controlPoint\n    /** Data array representing the actual file to transfer **/\n    this[fileSymbol] = fileData\n    /** The DFUObjectType this file represents */\n    this[typeSymbol] = objectType\n    /** empty list of DFUObject */\n    this[objectsSymbol] = []\n    this[progressSymbol] = 0.0\n  }\n\n  checkProgress () {\n    switch (this.state) {\n      case TransferStates.Completed:\n        this.progress = 1.0\n        break\n      case TransferStates.Failed:\n        this.progress = 1.0\n        break\n      case TransferStates.Transfer:\n        let percentagePerObject = 1.0/this.objects.length\n        this.progress = this.objects.reduce((sum,dfuObject) => {\n          switch (dfuObject.state) {\n            case DFUObjectStates.Completed:\n              return sum + percentagePerObject\n            case DFUObjectStates.Failed:\n              return sum + percentagePerObject\n            case DFUObjectStates.Storing:\n              return sum + percentagePerObject\n            case DFUObjectStates.Transfering:\n              let percentageCompleted = dfuObject.progress.completed / dfuObject.progress.size\n              return sum + (percentagePerObject * percentageCompleted)\n            default:\n              return sum\n          }\n        }, 0.0)\n        break;\n      default:\n        this.progress = 0.0\n    }\n  }\n\n  /** Begin the tranfer of a file by asking the NRF51/52 for meta data and verify if the file has been transfered already **/\n  begin () {\n    this.controlPoint.addEventListener('characteristicvaluechanged', this.onEvent.bind(this))\n    let operation = Task.verify(this.type, this.controlPoint)\n    Task.Worker(operation,() => {})\n  }\n\n  /** Clean up event registrations when transfer is completed **/\n  end () {\n    this.controlPoint.removeEventListener('characteristicvaluechanged', this.onEvent)\n  }\n\n  /**\n  Given the type of device and object type, the maxium size that can be processed\n  at a time varies. This method creates a set of DFUObject with this maxium size\n  set.\n\n  Secondly the device reports back how much of the file has been transfered and what the crc\n  so far is. This method skips object that has already been completed\n  **/\n  prepareDFUObjects (maxiumSize, currentOffset, currentCRC) {\n    this.maximumObjectLength = maxiumSize\n    this.currentObjectIndex = 0\n    this.generateObjects()\n    /** Skip to object for the offset **/\n    let object = this.objects.find((item) => item.hasOffset(currentOffset))\n    if (object) {\n      this.currentObjectIndex = this.objects.indexOf(object)\n    }\n    this.state = TransferStates.Transfer\n    this.objects[this.currentObjectIndex].validate(currentOffset, currentCRC)\n  }\n\n  /**\n  Internal convinence method.\n  **/\n  generateObjects () {\n    let fileBegin = 0\n    let fileEnd = this.file.length\n    let index = fileBegin\n    while (index < fileEnd) {\n      let objectBegin = index\n      let objectEnd = objectBegin + this.maximumObjectLength < fileEnd ? this.maximumObjectLength : (fileEnd - index)\n      let object = new DFUObject(objectBegin, objectEnd, this, this.type)\n      object.on('stateChanged', (event) => {\n        if(event.state === DFUObjectStates.Failed) {\n          this.state = TransferStates.Failed\n        } else if ( event.state === DFUObjectStates.Completed) {\n          this.nextObject()\n        }\n      })\n      object.on('progressChanged', (event) => this.checkProgress())\n      this.objects.push(object)\n      index += this.maximumObjectLength\n    }\n  }\n\n  /** handles events received on the Control Point Characteristic **/\n  onEvent (event) {\n    /** guard to filter events that are not response codes  */\n    let dataView = event.target.value\n    if (dataView && dataView.getInt8(0) !== TaskTypes.RESPONSE_CODE) {\n      console.warn('Transfer.onEvent() opcode was not a response code')\n      return\n    }\n    switch (this.state) {\n      case TransferStates.Prepare: {\n        let opCode = dataView.getInt8(1)\n        let responseCode = dataView.getInt8(2)\n        if (opCode === TaskTypes.SELECT && responseCode === TaskResults.SUCCESS) {\n          let maxiumSize = dataView.getUint32(3, true)\n          let currentOffset = dataView.getUint32(7, true)\n          let currentCRC = dataView.getUint32(11, true)\n          this.prepareDFUObjects(maxiumSize, currentOffset, currentCRC)\n        }\n        break\n      }\n      default: {\n        if (this.objects !== undefined && this.objects[this.currentObjectIndex] !== undefined) {\n          this.objects[this.currentObjectIndex].eventHandler(dataView)\n          if (this.objects[this.currentObjectIndex].state === DFUObjectStates.Failed) {\n            this.state == TransferStates.Failed\n          }\n        } else {\n          this.state = TransferStates.Failed\n        }\n        break\n      }\n    }\n  }\n\n  /** Checks if Transfer is complete or starts transferring the next DFUObject **/\n  nextObject () {\n    if (this.currentObjectIndex < this.objects.length - 1) {\n      this.currentObjectIndex++\n      this.objects[this.currentObjectIndex].begin()\n    } else {\n      this.state = TransferStates.Completed\n    }\n  }\n}\n\nexport default Transfer\n"]}